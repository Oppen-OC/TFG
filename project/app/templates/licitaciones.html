{% extends 'base.html' %}

{% block title %}Licitaciones{% endblock %}

{% block content %}
<h2 class="mb-4">Licitaciones</h2>

<!-- Cuadro con el n√∫mero de licitaciones y el total de euros -->
<div class="alert alert-info d-flex justify-content-between align-items-center" role="alert">
  <span>N√∫mero de licitaciones cargadas: <strong id="numLicitaciones">0</strong></span>
  <span>Total en euros: <strong id="totalLicitaciones">0</strong> ‚Ç¨</span>
</div>

<!-- Buscador en la parte superior derecha -->
<div class="d-flex justify-content-end mb-3 align-items-center gap-2">
  <select id="searchColumn" class="form-select w-auto">
    <option value="">Todas las columnas</option>
    <option value="0">Expediente</option>
    <option value="1">ID Publicaci√≥n TED</option>
    <option value="2">√ìrgano de Contrataci√≥n</option>
    <option value="3">ID √ìrgano Contrataci√≥n</option>
    <option value="4">Estado</option>
    <option value="5">Objeto del Contrato</option>
    <option value="6">Financiaci√≥n UE</option>
    <option value="7">Presupuesto base</option>
    <option value="8">Valor estimado</option>
    <option value="9">Tipo de Contrato</option>
    <option value="10">C√≥digo CPV</option>
    <option value="11">Lugar de Ejecuci√≥n</option>
    <option value="12">Sistema de Contrataci√≥n</option>
    <option value="13">Procedimiento de Contrataci√≥n</option>
    <option value="14">Tipo de Tramitaci√≥n</option>
    <option value="15">M√©todo Presentaci√≥n Oferta</option>
    <option value="16">Resultado</option>
    <option value="17">Adjudicatario</option>
    <option value="18">N¬∫ Licitadores Presentados</option>
    <option value="19">Importe de Adjudicaci√≥n</option>
  </select>
  <input type="text" id="searchInput" class="form-control w-25" placeholder="Buscar licitaciones..." onkeyup="filterTable()">
</div>

<div class="d-flex justify-content-end mb-3">
  <button id="updateButton" class="btn btn-success me-2">Actualizar Licitaciones</button>
  <button id="columnSelectorButton" class="btn btn-warning me-2">Seleccionar columnas</button>
  <button id="filterButton" class="btn btn-primary me-2">Aplicar Filtros</button>
  <button id="downloadButton" class="btn btn-secondary">Descargar Excel</button>
</div>

<style>
.table-responsive {
  width: 100%;
  max-width: 100vw;
  overflow-x: auto; /* Permite el desplazamiento horizontal */
}
.table {
  table-layout: auto; /* Permite que las columnas se ajusten al contenido */
  width: 100%; /* Asegura que la tabla ocupe todo el ancho disponible */
  border-collapse: collapse; /* Mejora la apariencia de las celdas */
}
.table th, .table td {
  font-size: 0.95em;
  vertical-align: top;
  word-break: break-word; /* Rompe las palabras largas */
  white-space: pre-wrap; /* Inserta saltos de l√≠nea si el texto es largo */
  padding: 0.7em;
  text-align: left;
}
.table th {
  max-width: 300px; /* Tama√±o m√°ximo para los encabezados */
}
.table td {
  max-width: 500px; /* Tama√±o m√°ximo para las celdas */
  min-width: 200px; /* Tama√±o m√≠nimo para las celdas */
  overflow-wrap: break-word; /* Rompe las palabras largas */
}
#hiddenColumnsContainer {
  overflow-x: auto;
}
#hiddenColumnsList {
  margin: 0;
  padding: 0;
  list-style: none;
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  gap: 6px;
}
#hiddenColumnsList .list-group-item {
  cursor: pointer;
  display: inline-block;
  padding: 2px 10px;
  border: 1px solid #ccc;
  border-radius: 12px;
  background-color: #f1f3f4;
  font-size: 0.92em;
  color: #555;
  white-space: nowrap;
  margin-bottom: 0;
  transition: background-color 0.2s;
}
#hiddenColumnsList .list-group-item:hover {
  background-color: #e0e0e0;
}
#tableScrollContainer {
  margin-bottom: 28px; /* deja espacio para la barra fija */
}
#fixedTableScrollbar {
  /* ya definido en el inline style */
}
#licitacionesTable {
  min-width: 1500px;
}
.filter-menu {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  padding: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}
.filter-menu input {
  width: 100%;
}
</style>


<div id="tableScrollContainer" class="table-responsive">
  <table class="table table-hover bg-white rounded shadow-sm" id="licitacionesTable">
    <thead class="thead-light">
      <tr>
        <th>
          Detalles
        </th>  

        <th>
        <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownExpediente" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownExpediente">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="0" id="filterExpediente">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(0)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(0)">Limpiar</button>
            </div>
          </div>
          Expediente
        </th>

        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownIDTED" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownIDTED">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="1" id="filterIDTED">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(1)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(1)">Limpiar</button>
            </div>
          </div>
          ID Publicaci√≥n TED
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownOrganoContratacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownOrganoContratacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="2" id="filterOrganoContratacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(2)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(2)">Limpiar</button>
            </div>
          </div>
          √ìrgano de Contrataci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownIDOrganoContratacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownIDOrganoContratacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="3" id="filterIDOrganoContratacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(3)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(3)">Limpiar</button>
            </div>
          </div>
          ID √ìrgano Contrataci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownEstado" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownEstado">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="4" id="filterEstado">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(4)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(4)">Limpiar</button>
            </div>
          </div>
          Estado
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownObjetoContrato" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownObjetoContrato">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="5" id="filterObjetoContrato">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(5)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(5)">Limpiar</button>
            </div>
          </div>
          Objeto del Contrato
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownFinanciacionUE" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownFinanciacionUE">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="6" id="filterFinanciacionUE">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(6)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(6)">Limpiar</button>
            </div>
          </div>
          Financiaci√≥n UE
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownPresupuestoBase" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownPresupuestoBase">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="7" id="filterPresupuestoBase">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(7)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(7)">Limpiar</button>
            </div>
          </div>
          Presupuesto base
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownValorEstimado" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownValorEstimado">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="8" id="filterValorEstimado">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(8)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(8)">Limpiar</button>
            </div>
          </div>
          Valor estimado
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownTipoContrato" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownTipoContrato">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="9" id="filterTipoContrato">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(9)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(9)">Limpiar</button>
            </div>
          </div>
          Tipo de Contrato
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownCodigoCPV" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownCodigoCPV">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="10" id="filterCodigoCPV">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(10)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(10)">Limpiar</button>
            </div>
          </div>
          C√≥digo CPV
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownLugarEjecucion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownLugarEjecucion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="11" id="filterLugarEjecucion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(11)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(11)">Limpiar</button>
            </div>
          </div>
          Lugar de Ejecuci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownSistemaContratacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownSistemaContratacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="12" id="filterSistemaContratacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(12)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(12)">Limpiar</button>
            </div>
          </div>
          Sistema de Contrataci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownProcedimientoContratacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownProcedimientoContratacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="13" id="filterProcedimientoContratacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(13)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(13)">Limpiar</button>
            </div>
          </div>
          Procedimiento de Contrataci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownTipoTramitacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownTipoTramitacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="14" id="filterTipoTramitacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(14)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(14)">Limpiar</button>
            </div>
          </div>
          Tipo de Tramitaci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownMetodoPresentacionOferta" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownMetodoPresentacionOferta">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="15" id="filterMetodoPresentacionOferta">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(15)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(15)">Limpiar</button>
            </div>
          </div>
          M√©todo Presentaci√≥n Oferta
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownResultado" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownResultado">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="16" id="filterResultado">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(16)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(16)">Limpiar</button>
            </div>
          </div>
          Resultado
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownAdjudicatario" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownAdjudicatario">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="17" id="filterAdjudicatario">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(17)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(17)">Limpiar</button>
            </div>
          </div>
          Adjudicatario
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownNumLicitadoresPresentados" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownNumLicitadoresPresentados">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="18" id="filterNumLicitadoresPresentados">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(18)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(18)">Limpiar</button>
            </div>
          </div>
          N¬∫ Licitadores Presentados
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownImporteAdjudicacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownImporteAdjudicacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="19" id="filterImporteAdjudicacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(19)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(19)">Limpiar</button>
            </div>
          </div>
          Importe de Adjudicaci√≥n
        </th>
        <th>
          Fecha Adjudicaci√≥n
        </th>
        <th>
          Fecha Formalizaci√≥n
        </th>
        <th>
          Fecha Desistimiento
        </th>
        <th>
          Fecha Presentaci√≥n Oferta
        </th>
        <th>
          Fecha Presentaci√≥n Solicitud
        </th>
      </tr>
    </thead>
    <tbody>
      {% for licitacion in licitaciones %}
      <tr>
        <td>
          <a href="{% url 'app:detalles_licitacion' licitacion.COD|urlencode %}" class="btn btn-primary btn-sm">Detalles</a>
        </td>
        <td>{{ licitacion.COD }}</td>
        <td>{{ licitacion.ID_Publicacion_TED }}</td>
        <td>{{ licitacion.Organo_Contratacion }}</td>
        <td>{{ licitacion.ID_Organo_Contratacion }}</td>        
        <td>{{ licitacion.Estado_Licitacion }}</td>
        <td>{{ licitacion.Objeto_Contrato }}</td>
        <td>{{ licitacion.Financiacion_UE }}</td>
        <td>{{ licitacion.Presupuesto_Base_Licitacion }}</td>
        <td>{{ licitacion.Valor_Estimado_Contrato }}</td>
        <td>{{ licitacion.Tipo_Contrato }}</td>
        <td>{{ licitacion.Codigo_CPV }}</td>
        <td>{{ licitacion.Lugar_Ejecucion }}</td>
        <td>{{ licitacion.Sistema_Contratacion }}</td>
        <td>{{ licitacion.Procedimiento_Contratacion }}</td>
        <td>{{ licitacion.Tipo_Tramitacion }}</td>
        <td>{{ licitacion.Metodo_Presentacion_Oferta }}</td>
        <td>{{ licitacion.Resultado }}</td>
        <td>{{ licitacion.Adjudicatario }}</td>
        <td>{{ licitacion.Num_Licitadores_Presentados }}</td>
        <td>{{ licitacion.Importe_Adjudicacion }}</td>
        <td>{{ licitacion.Fecha_Adjudicacion }}</td>
        <td>{{ licitacion.Fecha_Formalizacion }}</td>
        <td>{{ licitacion.Fecha_Desistimiento }}</td>
        <td>{{ licitacion.Fecha_Presentacion_Oferta }}</td>
        <td>{{ licitacion.Fecha_Presentacion_Solicitud }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal para filtros -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filterModalLabel">Aplicar Filtros</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="filterForm">
          <div class="mb-3">
            <label for="estadoFilter" class="form-label">Estado</label>
            <select id="estadoFilter" class="form-select">
            <option value="">-- Todos --</option>
            <option value="Licitaciones en plazo">Licitaciones en plazo</option>
            <option value="Anuncio Previo">Anuncio Previo</option>
            <option value="Publicada">Publicada</option>
            <option value="Evaluaci√≥n Previa">Evaluaci√≥n Previa</option>
            <option value="Evaluaci√≥n">Evaluaci√≥n</option>
            <option value="Adjudicada">Adjudicada</option>
            <option value="Parcialmente Adjudicada">Parcialmente Adjudicada</option>
            <option value="Adjudicaci√≥n Provisional">Adjudicaci√≥n Provisional</option>
            <option value="Resuelta">Resuelta</option>
            <option value="Parcialmente Resuelta">Parcialmente Resuelta</option>
            <option value="Desistida">Desistida</option>
            <option value="Anulada">Anulada</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="tipoContratoFilter" class="form-label">Tipo de Contrato</label>
            <select id="tipoContratoFilter" class="form-select">
              <option value="">Todos</option>
              <option value="Suministros">Suministros</option>
              <option value="Servicios">Servicios</option>
              <option value="Obras">Obras</option>
              <option value="Administrativo especial">Administrativo especial</option>
              <option value="Privado">Privado</option>
              <option value="Gesti√≥n de Servicios P√∫blicos">Gesti√≥n de Servicios P√∫blicos</option>
              <option value="Concesi√≥n de Servicios">Concesi√≥n de Servicios</option>
              <option value="Concesi√≥n de Obras P√∫blicas">Concesi√≥n de Obras P√∫blicas</option>
              <option value="Concesi√≥n de Obras">Concesi√≥n de Obras</option>
              <option value="Colaboraci√≥n entre el sector p√∫blico y sector privado">Colaboraci√≥n entre el sector p√∫blico y sector privado</option>
              <option value="Patrimonial">Patrimonial</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="presupuestoFilter" class="form-label">Presupuesto Base (Mayor a)</label>
            <input type="number" id="presupuestoFilter" class="form-control" placeholder="Ejemplo: 100000">
          </div>
          <div class="mb-3">
            <label for="fechaInicioFilter" class="form-label">Fecha de Inicio</label>
            <input type="date" id="fechaInicioFilter" class="form-control">
          </div>
          <div class="mb-3">
            <label for="fechaFinFilter" class="form-label">Fecha de Fin</label>
            <input type="date" id="fechaFinFilter" class="form-control">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" id="applyFiltersButton" class="btn btn-primary">Aplicar Filtros</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para seleccionar columnas -->
<div class="modal fade" id="columnSelectorModal" tabindex="-1" aria-labelledby="columnSelectorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="columnSelectorModalLabel">Seleccionar columnas a mostrar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex gap-2 mb-2">
          <button type="button" id="selectAllColumns" class="btn btn-sm btn-outline-primary">Seleccionar todas</button>
          <button type="button" id="deselectAllColumns" class="btn btn-sm btn-outline-secondary">Deseleccionar todas</button>
        </div>
        <form id="columnSelectorForm" class="d-flex flex-column gap-2"></form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" id="applyColumnSelection" class="btn btn-primary">Aplicar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bot√≥n para abrir el popup -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterPopup">
  Filtrar Licitaciones
</button>

<!-- Modal para el popup -->
<div class="modal fade" id="filterPopup" tabindex="-1" aria-labelledby="filterPopupLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filterPopupLabel">Filtrar Licitaciones</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="popupFilterForm">
          <div class="mb-3">
            <label for="popupFilterColumn" class="form-label">Selecciona una columna</label>
            <select id="popupFilterColumn" class="form-select">
              <option value="0">Expediente</option>
              <option value="1">ID Publicaci√≥n TED</option>
              <option value="2">√ìrgano de Contrataci√≥n</option>
              <option value="3">ID √ìrgano Contrataci√≥n</option>
              <option value="4">Estado</option>
              <option value="5">Objeto del Contrato</option>
              <option value="6">Financiaci√≥n UE</option>
              <option value="7">Presupuesto Base</option>
              <option value="8">Valor Estimado</option>
              <option value="9">Tipo de Contrato</option>
              <option value="10">C√≥digo CPV</option>
              <option value="11">Lugar de Ejecuci√≥n</option>
              <option value="12">Sistema de Contrataci√≥n</option>
              <option value="13">Procedimiento de Contrataci√≥n</option>
              <option value="14">Tipo de Tramitaci√≥n</option>
              <option value="15">M√©todo Presentaci√≥n Oferta</option>
              <option value="16">Resultado</option>
              <option value="17">Adjudicatario</option>
              <option value="18">N¬∫ Licitadores Presentados</option>
              <option value="19">Importe de Adjudicaci√≥n</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="popupFilterValue" class="form-label">Texto para buscar</label>
            <input type="text" id="popupFilterValue" class="form-control" placeholder="Introduce el texto">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" onclick="applyPopupFilter()">Filtrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Barra de scroll fija -->
<div id="fixedTableScrollbar" style="position:fixed; left:0; right:0; bottom:0; height:14px; background:#fff; z-index:1050; border-top:1px solid #ccc; display:none; overflow-x:auto; padding:0; margin:0;">
  <div id="fixedScrollbarInner" style="height:1px; margin:0; padding:0;"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
function filterTable() {
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    let isVisible = true;

    // Filtro por texto
    const textFilters = document.querySelectorAll('.filter-input');
    textFilters.forEach(filter => {
      const columnIndex = parseInt(filter.dataset.column);
      const filterValue = filter.value.toLowerCase().trim();
      const cell = row.cells[columnIndex];

      if (filterValue && cell) {
        const cellText = cell.textContent.toLowerCase().trim();
        if (!cellText.includes(filterValue)) {
          isVisible = false;
        }
      }
    });

    // Filtro por rango de fechas
    const dateFilters = [
      { columnIndex: 20, startDateId: 'fechaInicioAdjudicacion', endDateId: 'fechaFinAdjudicacion' },
      { columnIndex: 21, startDateId: 'fechaInicioFormalizacion', endDateId: 'fechaFinFormalizacion' },
      { columnIndex: 22, startDateId: 'fechaInicioDesistimiento', endDateId: 'fechaFinDesistimiento' },
      { columnIndex: 23, startDateId: 'fechaInicioPresentacionOferta', endDateId: 'fechaFinPresentacionOferta' },
      { columnIndex: 24, startDateId: 'fechaInicioPresentacionSolicitud', endDateId: 'fechaFinPresentacionSolicitud' },
    ];

    dateFilters.forEach(({ columnIndex, startDateId, endDateId }) => {
      const startDateInput = document.getElementById(startDateId).value;
      const endDateInput = document.getElementById(endDateId).value;

      const startDate = startDateInput ? new Date(startDateInput) : null;
      const endDate = endDateInput ? new Date(endDateInput) : null;
      const cell = row.cells[columnIndex];

      if (cell) {
        const cellText = cell.textContent.trim();
        const cellDate = new Date(cellText);

        if (startDate && isNaN(cellDate.getTime())) {
          isVisible = false;
        } else if (startDate && cellDate < startDate) {
          isVisible = false;
        }
        if (endDate && isNaN(cellDate.getTime())) {
          isVisible = false;
        } else if (endDate && cellDate > endDate) {
          isVisible = false;
        }
      }
    });

    row.style.display = isVisible ? '' : 'none'; // Mostrar u ocultar la fila
  });

  updateTotalLicitaciones(); // Actualizar el contador de licitaciones visibles
}

function toggleColumn(columnIndex) {
  const table = document.getElementById('licitacionesTable');
  const rows = table.getElementsByTagName('tr');
  const hiddenColumnsList = document.getElementById('hiddenColumnsList');

  let isHidden = false;

  for (let i = 0; i < rows.length; i++) {
    const headers = rows[i].getElementsByTagName('th');
    const cells = rows[i].getElementsByTagName('td');

    if (i === 0 && headers.length > columnIndex) {
      // Alternar visibilidad del encabezado
      const header = headers[columnIndex];
      if (header.style.display === 'none') {
        header.style.display = 'table-cell';
        // Eliminar de la lista de columnas ocultas
        const listItem = document.querySelector(`#hiddenColumnsList li[data-index="${columnIndex}"]`);
        if (listItem) listItem.remove();
      } else {
        header.style.display = 'none';
        isHidden = true;
        // A√±adir a la lista de columnas ocultas
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item';
        listItem.textContent = header.textContent;
        listItem.setAttribute('data-index', columnIndex);
        listItem.onclick = () => toggleColumn(columnIndex); // Restaurar al hacer clic
        hiddenColumnsList.appendChild(listItem);
      }
    } else if (cells.length > columnIndex) {
      // Alternar visibilidad de las celdas
      if (isHidden) {
        cells[columnIndex].style.display = 'none';
      } else {
        cells[columnIndex].style.display = 'table-cell';
      }
    }
  }

  // Actualizar la lista de columnas ocultas
  updateHiddenColumnsList();
}

function updateHiddenColumnsList() {
  const table = document.getElementById('licitacionesTable');
  const rows = table.getElementsByTagName('tr');
  const hiddenColumnsList = document.getElementById('hiddenColumnsList');

  // Limpiar la lista actual
  hiddenColumnsList.innerHTML = '';

  // Recorrer las columnas del encabezado
  const headers = rows[0].getElementsByTagName('th');
  for (let i = 0; i < headers.length; i++) {
    if (headers[i].style.display === 'none') {
      // Si la columna est√° oculta, agregarla a la lista
      const listItem = document.createElement('li');
      listItem.className = 'list-group-item';
      listItem.textContent = headers[i].textContent;
      listItem.setAttribute('data-index', i);
      listItem.onclick = () => toggleColumn(i); // Restaurar al hacer clic
      hiddenColumnsList.appendChild(listItem);
    }
  }

  updateHiddenColumnsVisibility();
}

function updateHiddenColumnsVisibility() {
  const hiddenColumnsContainer = document.getElementById('hiddenColumnsContainer');
  const hiddenColumnsList = document.getElementById('hiddenColumnsList');
  hiddenColumnsContainer.style.display = hiddenColumnsList.children.length > 0 ? 'block' : 'none';
}

document.getElementById('updateButton').addEventListener('click', async () => {
  if (confirm('¬øEst√°s seguro de que deseas actualizar las licitaciones?')) {
    try {
      const response = await fetch('http://127.0.0.1:5000/update-licitaciones', { // Cambia el puerto si es necesario
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      const result = await response.json();
      if (result.success) {
        alert(result.message);
        location.reload(); // Recarga la p√°gina para mostrar los datos actualizados
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error al actualizar las licitaciones.');
    }
  }
});

// Mostrar el modal al hacer clic en el bot√≥n "Aplicar Filtros"
document.getElementById('filterButton').addEventListener('click', () => {
  const filterModal = new bootstrap.Modal(document.getElementById('filterModal'));
  filterModal.show();
});

// Aplicar los filtros al hacer clic en "Aplicar Filtros"
document.getElementById('applyFiltersButton').addEventListener('click', () => {
  const estado = document.getElementById('estadoFilter').value.toLowerCase();
  const tipoContrato = document.getElementById('tipoContratoFilter').value.toLowerCase();
  const presupuesto = parseInt(document.getElementById('presupuestoFilter').value) || 0;
  const fechaInicio = new Date(document.getElementById('fechaInicioFilter').value);
  const fechaFin = new Date(document.getElementById('fechaFinFilter').value);

  const table = document.getElementById('licitacionesTable');
  const rows = table.getElementsByTagName('tr');
  let visibleCount = 0; // Contador de filas visibles

  for (let i = 1; i < rows.length; i++) { // Empieza en 1 para omitir el encabezado
    const cells = rows[i].getElementsByTagName('td');
    const estadoCell = cells[4]?.textContent.toLowerCase();
    const tipoContratoCell = cells[9]?.textContent.toLowerCase();
    const presupuestoCell = parseInt(cells[7]?.textContent.replace(/\./g, '').split(',')[0] || 0);
    const fechaCell = new Date(cells[2]?.textContent); // Cambia el √≠ndice seg√∫n la columna de fecha

    let match = true;

    if (estado && estadoCell !== estado) match = false;
    if (tipoContrato && tipoContratoCell !== tipoContrato) match = false;
    if (!isNaN(presupuesto) && presupuestoCell < presupuesto) match = false;
    if (!isNaN(fechaInicio.getTime()) && fechaCell < fechaInicio) match = false;
    if (!isNaN(fechaFin.getTime()) && fechaCell > fechaFin) match = false;

    rows[i].style.display = match ? '' : 'none';

    if (match) visibleCount++; // Incrementar el contador si la fila es visible
  }

  // Actualizar el contador en el DOM
  document.getElementById('numLicitaciones').textContent = visibleCount;
  updateTotalLicitaciones();

  // Cerrar el modal despu√©s de aplicar los filtros
  const filterModal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
  filterModal.hide();
});

document.getElementById('downloadButton').addEventListener('click', async () => {
  const table = document.getElementById('licitacionesTable');
  const rows = table.getElementsByTagName('tr');
  const data = [];
  const codList = []; // Lista para almacenar los c√≥digos visibles

  // Recorrer las filas visibles de la tabla
  for (let i = 0; i < rows.length; i++) {
    if (rows[i].style.display !== 'none') { // Solo incluir filas visibles
      const cells = rows[i].getElementsByTagName(i === 0 ? 'th' : 'td'); // Usar 'th' para encabezados
      const rowData = [];
      for (let j = 0; j < cells.length; j++) {
        rowData.push(cells[j].textContent.trim());
      }
      data.push(rowData);

      // Agregar el c√≥digo (COD) a codList si no es la fila de encabezado
      if (i > 0) {
        codList.push(cells[0].textContent.trim()); // Suponiendo que el COD est√° en la primera columna
      }
    }
  }

  // Crear la primera hoja con los datos de la tabla actual
  const ws1 = XLSX.utils.aoa_to_sheet(data); // Convierte los datos a una hoja de c√°lculo
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws1, 'Licitaciones');

  // Obtener los datos de la tabla SQL "anexoI" desde el servidor
  try {
    const response = await fetch('http://127.0.0.1:5000/get-anexoI-data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ cod_list: codList }) // Enviar codList al servidor
    });

    const anexoIData = await response.json();

    // Convertir los datos de "anexoI" a un formato adecuado para Excel
    const anexoIArray = [];
    if (anexoIData.length > 0) {
      // Agregar encabezados
      anexoIArray.push(Object.keys(anexoIData[0]));
      // Agregar filas
      anexoIData.forEach(row => {
        anexoIArray.push(Object.values(row));
      });
    }

    // Crear la segunda hoja con los datos de "anexoI"
    const ws2 = XLSX.utils.aoa_to_sheet(anexoIArray);
    XLSX.utils.book_append_sheet(wb, ws2, 'anexoI');
  } catch (error) {
    console.error('Error al obtener los datos de anexoI:', error);
    alert('No se pudo agregar la hoja "anexoI" al archivo Excel.');
  }

  // Descargar el archivo
  XLSX.writeFile(wb, 'licitaciones_con_anexoI.xlsx');
});

document.addEventListener('DOMContentLoaded', () => {
  const rows = document.querySelectorAll('#licitacionesTable tbody tr');
  const totalLicitaciones = rows.length;
  document.getElementById('totalLicitaciones').textContent = totalLicitaciones;
  document.getElementById('numLicitaciones').textContent = totalLicitaciones;
  updateTotalLicitaciones();
});

// Bot√≥n para abrir el modal de selecci√≥n de columnas
document.getElementById('columnSelectorButton').addEventListener('click', () => {
  const table = document.getElementById('licitacionesTable');
  const headers = table.querySelectorAll('thead th');
  const form = document.getElementById('columnSelectorForm');
  form.innerHTML = '';
  headers.forEach((th, i) => {
    // No permitir ocultar la columna de acciones (√∫ltima)
    if (i === headers.length - 1) return;
    const checked = th.style.display !== 'none' ? 'checked' : '';
    form.innerHTML += `
      <div>
        <input type="checkbox" id="colCheck${i}" data-index="${i}" ${checked}>
        <label for="colCheck${i}">${th.textContent}</label>
      </div>
    `;
  });
  const modal = new bootstrap.Modal(document.getElementById('columnSelectorModal'));
  modal.show();
});

// Aplicar selecci√≥n de columnas
document.getElementById('applyColumnSelection').addEventListener('click', () => {
  const table = document.getElementById('licitacionesTable');
  const headers = table.querySelectorAll('thead th');
  const rows = table.querySelectorAll('tbody tr');
  const checks = document.querySelectorAll('#columnSelectorForm input[type="checkbox"]');
  checks.forEach(check => {
    const idx = parseInt(check.dataset.index);
    headers[idx].style.display = check.checked ? '' : 'none';
    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells[idx]) cells[idx].style.display = check.checked ? '' : 'none';
    });
  });
  // Cerrar el modal
  bootstrap.Modal.getInstance(document.getElementById('columnSelectorModal')).hide();
  updateHiddenColumnsList();
});

// Seleccionar todas las columnas
document.getElementById('selectAllColumns').addEventListener('click', () => {
  document.querySelectorAll('#columnSelectorForm input[type="checkbox"]').forEach(cb => cb.checked = true);
});

// Deseleccionar todas las columnas
document.getElementById('deselectAllColumns').addEventListener('click', () => {
  document.querySelectorAll('#columnSelectorForm input[type="checkbox"]').forEach(cb => cb.checked = false);
});

function applyFilter(columnIndex) {
  const input = document.querySelector(`.filter-input[data-column="${columnIndex}"]`);
  const filterValue = input.value.toLowerCase().trim();
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    const cell = row.cells[columnIndex];
    if (cell) {
      const cellText = cell.textContent.toLowerCase().trim();
      if (!cellText.includes(filterValue)) {
        row.dataset.visible = 'false'; // Marca la fila como no visible
      }
    }
  });

  updateVisibility();
}

function clearFilter(columnIndex) {
  const input = document.querySelector(`.filter-input[data-column="${columnIndex}"]`);
  input.value = '';
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    row.dataset.visible = 'true'; // Marca la fila como visible
  });

  updateVisibility();
}

function updateVisibility() {
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    const isVisible = Array.from(row.cells).every(cell => {
      return row.dataset.visible !== 'false';
    });

    row.style.display = isVisible ? '' : 'none'; // Muestra u oculta la fila
  });

  updateTotalLicitaciones(); // Actualizar el contador de licitaciones visibles
}

function updateTotalLicitaciones() {
  const rows = document.querySelectorAll('#licitacionesTable tbody tr');
  let visibleCount = 0;

  rows.forEach(row => {
    if (row.style.display !== 'none') visibleCount++;
  });

  const totalLicitacionesElement = document.getElementById('totalLicitaciones');
  const numLicitacionesElement = document.getElementById('numLicitaciones');

  if (totalLicitacionesElement) {
    totalLicitacionesElement.textContent = visibleCount;
  }

  if (numLicitacionesElement) {
    numLicitacionesElement.textContent = visibleCount;
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const tableContainer = document.getElementById('tableScrollContainer');
  const fixedScrollbar = document.getElementById('fixedTableScrollbar');
  const fixedScrollbarInner = document.getElementById('fixedScrollbarInner');
  const table = document.getElementById('licitacionesTable');

  function updateScrollbarWidth() {
    setTimeout(() => {
      fixedScrollbarInner.style.width = table.scrollWidth + 'px';
    }, 0);
  }

  fixedScrollbar.addEventListener('scroll', function () {
    tableContainer.scrollLeft = fixedScrollbar.scrollLeft;
  });

  tableContainer.addEventListener('scroll', function () {
    fixedScrollbar.scrollLeft = tableContainer.scrollLeft;
  });

  function toggleScrollbar() {
    if (table.scrollWidth > tableContainer.clientWidth) {
      fixedScrollbar.style.display = 'block';
      updateScrollbarWidth();
    } else {
      fixedScrollbar.style.display = 'none';
    }
  }

  toggleScrollbar();
  window.addEventListener('resize', toggleScrollbar);
});

function toggleFilterMenu(event, columnIndex) {
  const menus = document.querySelectorAll('.filter-menu');
  menus.forEach(menu => (menu.style.display = 'none'));

  const menu = document.querySelector(`.filter-menu[data-column="${columnIndex}"]`);
  const icon = event.target;
  const rect = icon.getBoundingClientRect();

  menu.style.display = 'block';
  menu.style.top = `${rect.bottom + window.scrollY}px`;
  menu.style.left = `${rect.left + window.scrollX}px`;
}

function filterByColumn(input) {
  const columnIndex = parseInt(input.dataset.column);
  const filterValue = input.value.toLowerCase().trim();
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    const cell = row.cells[columnIndex];
    if (cell) {
      const cellText = cell.textContent.toLowerCase().trim();
      row.style.display = cellText.includes(filterValue) ? '' : 'none';
    }
  });

  updateTotalLicitaciones();
}

function applyFilter(columnIndex) {
  const input = document.getElementById(`filterExpediente`);
  const filterValue = input.value.toLowerCase().trim();
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    const cell = row.cells[columnIndex];
    if (cell) {
      const cellText = cell.textContent.toLowerCase().trim();
      row.style.display = cellText.includes(filterValue) ? '' : 'none';
    }
  });

  updateTotalLicitaciones();
}

function clearFilter(columnIndex) {
  const input = document.getElementById(`filterExpediente`);
  input.value = '';
  applyFilter(columnIndex);
}

document.addEventListener('DOMContentLoaded', () => {
  const filterIcons = document.querySelectorAll('.filter-icon');
  filterIcons.forEach((icon, index) => {
    icon.addEventListener('click', event => toggleFilterMenu(event, index));
  });
});

function applyFilter(columnIndex) {
  const input = document.querySelector(`.filter-input[data-column="${columnIndex}"]`);
  const filterValue = input.value.toLowerCase().trim();
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    const cell = row.cells[columnIndex];
    if (cell) {
      const cellText = cell.textContent.toLowerCase().trim();
      if (!cellText.includes(filterValue)) {
        row.dataset.visible = 'false'; // Marca la fila como no visible
      }
    }
  });

  updateVisibility();
}

function clearFilter(columnIndex) {
  const input = document.querySelector(`.filter-input[data-column="${columnIndex}"]`);
  input.value = '';
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    row.dataset.visible = 'true'; // Marca la fila como visible
  });

  updateVisibility();
}

function updateVisibility() {
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    const isVisible = Array.from(row.cells).every(cell => {
      return row.dataset.visible !== 'false';
    });

    row.style.display = isVisible ? '' : 'none'; // Muestra u oculta la fila
  });

  updateTotalLicitaciones(); // Actualizar el contador de licitaciones visibles
}

function updateTotalLicitaciones() {
  const rows = document.querySelectorAll('#licitacionesTable tbody tr');
  let visibleCount = 0;

  rows.forEach(row => {
    if (row.style.display !== 'none') visibleCount++;
  });

  const totalLicitacionesElement = document.getElementById('totalLicitaciones');
  const numLicitacionesElement = document.getElementById('numLicitaciones');

  if (totalLicitacionesElement) {
    totalLicitacionesElement.textContent = visibleCount;
  }

  if (numLicitacionesElement) {
    numLicitacionesElement.textContent = visibleCount;
  }
}
</script>

{% endblock %}