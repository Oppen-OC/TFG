{% extends 'base.html' %}

{% block title %}Licitaciones{% endblock %}

{% block content %}
<h2 class="mb-4">Licitaciones</h2>

<!-- Cuadro con el n√∫mero de licitaciones y el total de euros -->
<div class="alert alert-info d-flex justify-content-between align-items-center" role="alert">
  <span>N√∫mero de licitaciones cargadas: <strong id="numLicitaciones">0</strong></span>
  <span>Total en euros: <strong id="totalLicitaciones">0</strong> ‚Ç¨</span>
</div>

<!-- Buscador en la parte superior derecha -->
<div class="d-flex justify-content-end mb-3 align-items-center gap-2">
  <select id="searchColumn" class="form-select w-auto">
    <option value="">Todas las columnas</option>
    <option value="0">Expediente</option>
    <option value="1">ID Publicaci√≥n TED</option>
    <option value="2">√ìrgano de Contrataci√≥n</option>
    <option value="3">ID √ìrgano Contrataci√≥n</option>
    <option value="4">Estado</option>
    <option value="5">Objeto del Contrato</option>
    <option value="6">Financiaci√≥n UE</option>
    <option value="7">Presupuesto base</option>
    <option value="8">Valor estimado</option>
    <option value="9">Tipo de Contrato</option>
    <option value="10">C√≥digo CPV</option>
    <option value="11">Lugar de Ejecuci√≥n</option>
    <option value="12">Sistema de Contrataci√≥n</option>
    <option value="13">Procedimiento de Contrataci√≥n</option>
    <option value="14">Tipo de Tramitaci√≥n</option>
    <option value="15">M√©todo Presentaci√≥n Oferta</option>
    <option value="16">Resultado</option>
    <option value="17">Adjudicatario</option>
    <option value="18">N¬∫ Licitadores Presentados</option>
    <option value="19">Importe de Adjudicaci√≥n</option>
  </select>
  <input type="text" id="searchInput" class="form-control w-25" placeholder="Buscar licitaciones..." onkeyup="filterTable()">
</div>

<div class="d-flex justify-content-end mb-3">
  <button id="updateButton" class="btn btn-success me-2">Actualizar Licitaciones</button>
  <button id="columnSelectorButton" class="btn btn-warning me-2">Seleccionar Columnas</button>
  <button id="filterButton" class="btn btn-primary me-2" onclick="clearAllFilters()">Limpiar Filtros</button>
  <button id="downloadButton" class="btn btn-secondary">Descargar Excel</button>
</div>

<style>
.table-responsive {
  width: 100%;
  max-width: 100vw;
  overflow-x: auto; /* Permite el desplazamiento horizontal */
}
.table {
  table-layout: auto; /* Permite que las columnas se ajusten al contenido */
  width: 100%; /* Asegura que la tabla ocupe todo el ancho disponible */
  border-collapse: collapse; /* Mejora la apariencia de las celdas */
}
.table th, .table td {
  font-size: 0.95em;
  vertical-align: top;
  word-break: break-word; /* Rompe las palabras largas */
  white-space: pre-wrap; /* Inserta saltos de l√≠nea si el texto es largo */
  padding: 0.7em;
  text-align: left;
}
.table th {
  max-width: 300px; /* Tama√±o m√°ximo para los encabezados */
  text-align: center;
  vertical-align: middle;
  padding: 10px;
  white-space: nowrap; /* Evita saltos de l√≠nea */
  font-size: 0.9em; /* Ajusta el tama√±o del texto */
}
.table td {
  max-width: 500px; /* Tama√±o m√°ximo para las celdas */
  min-width: 200px; /* Tama√±o m√≠nimo para las celdas */
  overflow-wrap: break-word; /* Rompe las palabras largas */
  text-align: left;
  vertical-align: top;
  padding: 10px;
}
#hiddenColumnsContainer {
  overflow-x: auto;
}
#hiddenColumnsList {
  margin: 0;
  padding: 0;
  list-style: none;
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  gap: 6px;
}
#hiddenColumnsList .list-group-item {
  cursor: pointer;
  display: inline-block;
  padding: 2px 10px;
  border: 1px solid #ccc;
  border-radius: 12px;
  background-color: #f1f3f4;
  font-size: 0.92em;
  color: #555;
  white-space: nowrap;
  margin-bottom: 0;
  transition: background-color 0.2s;
}
#hiddenColumnsList .list-group-item:hover {
  background-color: #e0e0e0;
}
#tableScrollContainer {
  margin-bottom: 28px; /* deja espacio para la barra fija */
}
#fixedTableScrollbar {
  /* ya definido en el inline style */
}
#licitacionesTable {
  min-width: 1500px;
}
.filter-menu {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  padding: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}
.filter-menu input {
  width: 100%;
}

/* Estilo para los encabezados de las columnas */
.column-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
}

.column-header span {
  font-weight: bold;
  font-size: 0.9em;
  text-align: center;
  white-space: nowrap;
}

/* Estilo para los men√∫s desplegables */
.dropdown-menu {
  width: 250px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.dropdown-toggle {
  font-size: 0.8em;
  padding: 5px 10px;
  border-radius: 8px;
  background-color: #007bff;
  color: white;
}

.dropdown-toggle:hover {
  background-color: #0056b3;
}

/* Estilo para los botones de acci√≥n */
.btn-primary {
  background-color: #007bff;
  border-color: #007bff;
}

.btn-primary:hover {
  background-color: #0056b3;
  border-color: #0056b3;
}

.btn-secondary {
  background-color: #6c757d;
  border-color: #6c757d;
}

.btn-secondary:hover {
  background-color: #5a6268;
  border-color: #5a6268;
}

/* Estilo para las filas de la tabla */
.table-hover tbody tr:hover {
  background-color: #f1f1f1;
}

/* Estilo para los filtros de rango de fechas */
.filter-date {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.filter-date label {
  font-size: 0.85em;
  font-weight: bold;
}

.filter-date input {
  font-size: 0.85em;
  padding: 5px;
  border-radius: 4px;
  border: 1px solid #ccc;
}
</style>


<div id="tableScrollContainer" class="table-responsive">
  <table class="table table-hover bg-white rounded shadow-sm" id="licitacionesTable">
    <thead class="thead-light">
      <tr>
        <th>
          Detalles
        </th>  
        <th>
          <div class="column-header">
            <div class="dropdown">
              <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownExpediente" data-bs-toggle="dropdown" aria-expanded="false">
                üîç
              </button>
              <div class="dropdown-menu p-3" aria-labelledby="dropdownExpediente">
                <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="1" id="filterExpediente">
                <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(1)">Filtrar</button>
                <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(1)">Limpiar</button>
              </div>
            </div>
          </div>
          Expediente
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownTED" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownTED">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="2" id="filterTED">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(2)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(2)">Limpiar</button>
            </div>
          </div>
          Publicaci√≥n TED
        </th> 
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownOrganoContrato" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownOrganoContrato">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="3" id="filterOrganoContrato">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(3)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(3)">Limpiar</button>
            </div>
          </div>
          Objeto del Contrato
        </th>        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownObjetoIDOrgano" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownObjetoIDOrgano">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="4" id="filterIDOrgano">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(4)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(4)">Limpiar</button>
            </div>
          </div>
          Objeto del Contrato
        </th>        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownEstado" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownObjetoEstado">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="5" id="filterObjetoEstado">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(5)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(5)">Limpiar</button>
            </div>
          </div>
          Objeto del Contrato
        </th>        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownObjetoContrato" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownObjetoContrato">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="6" id="filterObjetoContrato">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(6)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(6)">Limpiar</button>
            </div>
          </div>
          Objeto del Contrato
        </th>  
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownFinanciacionUE" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownFinanciacionUE">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="7" id="filterFinanciacionUE">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(7)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(7)">Limpiar</button>
            </div>
          </div>
          Financiaci√≥n UE
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownPresupuestoBase" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownPresupuestoBase">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="8" id="filterPresupuestoBase">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(8)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(8)">Limpiar</button>
            </div>
          </div>
          Presupuesto base
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownValorEstimado" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownValorEstimado">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="9" id="filterValorEstimado">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(9)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(9)">Limpiar</button>
            </div>
          </div>
          Valor estimado
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownTipoContrato" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownTipoContrato">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="10" id="filterTipoContrato">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(10)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(10)">Limpiar</button>
            </div>
          </div>
          Tipo de Contrato
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownCodigoCPV" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownCodigoCPV">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="11" id="filterCodigoCPV">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(11)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(11)">Limpiar</button>
            </div>
          </div>
          C√≥digo CPV
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownLugarEjecucion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownLugarEjecucion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="12" id="filterLugarEjecucion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(12)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(12)">Limpiar</button>
            </div>
          </div>
          Lugar de ejeuci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownSistemaContratacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownSistemaContratacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="13" id="filterSistemaContratacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(13)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(13)">Limpiar</button>
            </div>
          </div>
          Sistema de Contrataci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownProcedimientoContratacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownProcedimientoContratacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="14" id="filterProcedimientoContratacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(14)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(14)">Limpiar</button>
            </div>
          </div>
          Procedimiento de Contrataci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownTipoTramitacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownTipoTramitacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="15" id="filterTipoTramitacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(15)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(15)">Limpiar</button>
            </div>
          </div>
          Tipo de Tramitaci√≥n
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownMetodoPresentacionOferta" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownMetodoPresentacionOferta">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="16" id="filterMetodoPresentacionOferta">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(16)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(16)">Limpiar</button>
            </div>
          </div>
          M√©todo Presentaci√≥n Oferta
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownResultado" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownResultado">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="17" id="filterResultado">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(17)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(17)">Limpiar</button>
            </div>
          </div>
          Resultado
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownAdjudicatario" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownAdjudicatario">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="18" id="filterAdjudicatario">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(18)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(18)">Limpiar</button>
            </div>
          </div>
          Adjudicatario
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownNumLicitadoresPresentados" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownNumLicitadoresPresentados">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="19" id="filterNumLicitadoresPresentados">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(19)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(19)">Limpiar</button>
            </div>
          </div>
          N¬∫ Licitadores Presentados
        </th>
        <th>
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownImporteAdjudicacion" data-bs-toggle="dropdown" aria-expanded="false">
              üîç
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownImporteAdjudicacion">
              <input type="text" class="form-control filter-input" placeholder="Buscar..." data-column="20" id="filterImporteAdjudicacion">
              <button class="btn btn-primary btn-sm mt-2" onclick="applyFilter(20)">Filtrar</button>
              <button class="btn btn-secondary btn-sm mt-2" onclick="clearFilter(20)">Limpiar</button>
            </div>
          </div>
          Importe de Adjudicaci√≥n
        </th>
        <th>
          <div class="column-header">
            <span>Fecha Adjudicaci√≥n</span>
            <div class="dropdown">
              <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownFechaAdjudicacion" data-bs-toggle="dropdown" aria-expanded="false">
                üîç
              </button>
              <div class="dropdown-menu p-3" aria-labelledby="dropdownFechaAdjudicacion">
                <label for="fechaInicioAdjudicacion" class="form-label">Fecha Inicial</label>
                <input type="date" class="form-control" id="fechaInicioAdjudicacion">
                <label for="fechaFinAdjudicacion" class="form-label mt-2">Fecha Final</label>
                <input type="date" class="form-control" id="fechaFinAdjudicacion">
                <button class="btn btn-primary btn-sm mt-2" onclick="applyDateFilter(21)">Filtrar</button>
                <button class="btn btn-secondary btn-sm mt-2" onclick="clearDateFilter(21)">Limpiar</button>
              </div>
            </div>
          </div>
        </th>
       <th>
          <div class="column-header">
            <span>Fecha Formalizaci√≥n</span>
            <div class="dropdown">
              <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownFechaFormalizacion" data-bs-toggle="dropdown" aria-expanded="false">
                üîç
              </button>
              <div class="dropdown-menu p-3" aria-labelledby="dropdownFechaFormalizacion">
                <label for="fechaInicioFormalizacion" class="form-label">Fecha Inicial</label>
                <input type="date" class="form-control" id="fechaInicioFormalizacion">
                <label for="fechaFinFormalizacion" class="form-label mt-2">Fecha Final</label>
                <input type="date" class="form-control" id="fechaFinFormalizacion">
                <button class="btn btn-primary btn-sm mt-2" onclick="applyDateFilter(22)">Filtrar</button>
                <button class="btn btn-secondary btn-sm mt-2" onclick="clearDateFilter(22)">Limpiar</button>
              </div>
            </div>
          </div>
        </th>
          <th>
            <div class="column-header">
              <span>Fecha Desistimiento</span>
              <div class="dropdown">
                <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownFechaDesistimiento" data-bs-toggle="dropdown" aria-expanded="false">
                  üîç
                </button>
                <div class="dropdown-menu p-3" aria-labelledby="dropdownFechaDesistimiento">
                  <label for="fechaInicioDesistimiento" class="form-label">Fecha Inicial</label>
                  <input type="date" class="form-control" id="fechaInicioDesistimiento">
                  <label for="fechaFinDesistimiento" class="form-label mt-2">Fecha Final</label>
                  <input type="date" class="form-control" id="fechaFinDesistimiento">
                  <button class="btn btn-primary btn-sm mt-2" onclick="applyDateFilter(23)">Filtrar</button>
                  <button class="btn btn-secondary btn-sm mt-2" onclick="clearDateFilter(23)">Limpiar</button>
                </div>
              </div>
            </div>
          </th>
          <th>
            <div class="column-header">
              <span>Fecha Presentaci√≥n Oferta</span>
              <div class="dropdown">
                <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownFechaPresentacionOferta" data-bs-toggle="dropdown" aria-expanded="false">
                  üîç
                </button>
                <div class="dropdown-menu p-3" aria-labelledby="dropdownFechaPresentacionOferta">
                  <label for="fechaInicioPresentacionOferta" class="form-label">Fecha Inicial</label>
                  <input type="date" class="form-control" id="fechaInicioPresentacionOferta">
                  <label for="fechaFinPresentacionOferta" class="form-label mt-2">Fecha Final</label>
                  <input type="date" class="form-control" id="fechaFinPresentacionOferta">
                  <button class="btn btn-primary btn-sm mt-2" onclick="applyDateFilter(24)">Filtrar</button>
                  <button class="btn btn-secondary btn-sm mt-2" onclick="clearDateFilter(24)">Limpiar</button>
                </div>
              </div>
            </div>
          </th>
          <th>
            <div class="column-header">
              <span>Fecha Presentaci√≥n Solicitud</span>
              <div class="dropdown">
                <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownFechaPresentacionSolicitud" data-bs-toggle="dropdown" aria-expanded="false">
                  üîç
                </button>
                <div class="dropdown-menu p-3" aria-labelledby="dropdownFechaPresentacionSolicitud">
                  <label for="fechaInicioPresentacionSolicitud" class="form-label">Fecha Inicial</label>
                  <input type="date" class="form-control" id="fechaInicioPresentacionSolicitud">
                  <label for="fechaFinPresentacionSolicitud" class="form-label mt-2">Fecha Final</label>
                  <input type="date" class="form-control" id="fechaFinPresentacionSolicitud">
                  <button class="btn btn-primary btn-sm mt-2" onclick="applyDateFilter(25)">Filtrar</button>
                  <button class="btn btn-secondary btn-sm mt-2" onclick="clearDateFilter(25)">Limpiar</button>
                </div>
              </div>
            </div>
          </th>
      </tr>
    </thead>
    <tbody>
      {% for licitacion in licitaciones %}
      <tr>
        <td>
          <a href="{% url 'app:detalles_licitacion' licitacion.COD|urlencode %}" class="btn btn-primary btn-sm">Detalles</a>
        </td>
        <td>{{ licitacion.COD }}</td>
        <td>{{ licitacion.ID_Publicacion_TED }}</td>
        <td>{{ licitacion.Organo_Contratacion }}</td>
        <td>{{ licitacion.ID_Organo_Contratacion }}</td>        
        <td>{{ licitacion.Estado_Licitacion }}</td>
        <td>{{ licitacion.Objeto_Contrato }}</td>
        <td>{{ licitacion.Financiacion_UE }}</td>
        <td>{{ licitacion.Presupuesto_Base }}</td>
        <td>{{ licitacion.Valor_Estimado_Contrato }}</td>
        <td>{{ licitacion.Tipo_Contrato }}</td>
        <td>{{ licitacion.Codigo_CPV }}</td>
        <td>{{ licitacion.Lugar_Ejecucion }}</td>
        <td>{{ licitacion.Sistema_Contratacion }}</td>
        <td>{{ licitacion.Procedimiento_Contratacion }}</td>
        <td>{{ licitacion.Tipo_Tramitacion }}</td>
        <td>{{ licitacion.Metodo_Presentacion_Oferta }}</td>
        <td>{{ licitacion.Resultado }}</td>
        <td>{{ licitacion.Adjudicatario }}</td>
        <td>{{ licitacion.Numero_Licitaciones_Presentadas }}</td>
        <td>{{ licitacion.Importe_Adjudicacion }}</td>
        <td>{{ licitacion.Fecha_Adjudicacion }}</td>
        <td>{{ licitacion.Fecha_Formalizacion }}</td>
        <td>{{ licitacion.Fecha_Desistimiento }}</td>
        <td>{{ licitacion.Fecha_Presentacion_Oferta }}</td>
        <td>{{ licitacion.Fecha_Presentacion_Solicitud }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal para seleccionar columnas -->
<div class="modal fade" id="columnSelectorModal" tabindex="-1" aria-labelledby="columnSelectorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="columnSelectorModalLabel">Seleccionar columnas a mostrar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex gap-2 mb-2">
          <button type="button" id="selectAllColumns" class="btn btn-sm btn-outline-primary">Seleccionar todas</button>
          <button type="button" id="deselectAllColumns" class="btn btn-sm btn-outline-secondary">Deseleccionar todas</button>
        </div>
        <form id="columnSelectorForm" class="d-flex flex-column gap-2"></form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" id="applyColumnSelection" class="btn btn-primary">Aplicar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bot√≥n para abrir el popup -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterPopup">
  Filtrar Licitaciones
</button>

<!-- Modal para el popup -->
<div class="modal fade" id="filterPopup" tabindex="-1" aria-labelledby="filterPopupLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filterPopupLabel">Filtrar Licitaciones</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="popupFilterForm">
          <div class="mb-3">
            <label for="popupFilterColumn" class="form-label">Selecciona una columna</label>
            <select id="popupFilterColumn" class="form-select">
              <option value="1">Expediente</option>
              <option value="2">ID Publicaci√≥n TED</option>
              <option value="3">√ìrgano de Contrataci√≥n</option>
              <option value="4">ID √ìrgano Contrataci√≥n</option>
              <option value="5">Estado</option>
              <option value="6">Objeto del Contrato</option>
              <option value="7">Financiaci√≥n UE</option>
              <option value="8">Presupuesto Base</option>
              <option value="9">Valor Estimado</option>
              <option value="10">Tipo de Contrato</option>
              <option value="11">C√≥digo CPV</option>
              <option value="12">Lugar de Ejecuci√≥n</option>
              <option value="13">Sistema de Contrataci√≥n</option>
              <option value="14">Procedimiento de Contrataci√≥n</option>
              <option value="15">Tipo de Tramitaci√≥n</option>
              <option value="16">M√©todo Presentaci√≥n Oferta</option>
              <option value="17">Resultado</option>
              <option value="18">Adjudicatario</option>
              <option value="19">N¬∫ Licitadores Presentados</option>
              <option value="20">Importe de Adjudicaci√≥n</option>
              <option value="21">Fecha Adjudicaci√≥n</option>
              <option value="22">Fecha Formalizaci√≥n</option>
              <option value="23">Fecha Desistimiento</option>
              <option value="24">Fecha Presentaci√≥n Oferta</option>
              <option value="25">Fecha Presentaci√≥n Solicitud</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="popupFilterValue" class="form-label">Texto para buscar</label>
            <input type="text" id="popupFilterValue" class="form-control" placeholder="Introduce el texto">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" onclick="applyPopupFilter()">Filtrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Barra de scroll fija -->
<div id="fixedTableScrollbar" style="position:fixed; left:0; right:0; bottom:0; height:14px; background:#fff; z-index:1050; border-top:1px solid #ccc; display:none; overflow-x:auto; padding:0; margin:0;">
  <div id="fixedScrollbarInner" style="height:1px; margin:0; padding:0;"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const columnFilters = []; // Array para almacenar los valores de los filtros aplicados

function filterTable() {
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    let isVisible = true;

    // Filtro por texto
    const textFilters = document.querySelectorAll('.filter-input');
    textFilters.forEach(filter => {
      const columnIndex = parseInt(filter.dataset.column);
      const filterValue = filter.value.toLowerCase().trim();
      const cell = row.cells[columnIndex];

      if (filterValue && cell) {
        const cellText = cell.textContent.toLowerCase().trim();
        if (!cellText.includes(filterValue)) {
          isVisible = false;
        }
      }
    });

    // Filtro por rango de fechas
    const dateFilters = [
      { columnIndex: 21, startDateId: 'fechaInicioAdjudicacion', endDateId: 'fechaFinAdjudicacion' },
      { columnIndex: 22, startDateId: 'fechaInicioFormalizacion', endDateId: 'fechaFinFormalizacion' },
      { columnIndex: 23, startDateId: 'fechaInicioDesistimiento', endDateId: 'fechaFinDesistimiento' },
      { columnIndex: 23, startDateId: 'fechaInicioPresentacionOferta', endDateId: 'fechaFinPresentacionOferta' },
      { columnIndex: 25, startDateId: 'fechaInicioPresentacionSolicitud', endDateId: 'fechaFinPresentacionSolicitud' },
    ];

    dateFilters.forEach(({ columnIndex, startDateId, endDateId }) => {
      const startDateInput = document.getElementById(startDateId).value;
      const endDateInput = document.getElementById(endDateId).value;

      const startDate = startDateInput ? new Date(startDateInput) : null;
      const endDate = endDateInput ? new Date(endDateInput) : null;
      const cell = row.cells[columnIndex];

      if (cell) {
        const cellText = cell.textContent.trim();
        const cellDate = new Date(cellText);

        if (startDate && isNaN(cellDate.getTime())) {
          isVisible = false;
        } else if (startDate && cellDate < startDate) {
          isVisible = false;
        }
        if (endDate && isNaN(cellDate.getTime())) {
          isVisible = false;
        } else if (endDate && cellDate > endDate) {
          isVisible = false;
        }
      }
    });

    row.style.display = isVisible ? '' : 'none'; // Mostrar u ocultar la fila
  });

  updateTotalLicitaciones(); // Actualizar el contador de licitaciones visibles
}


function toggleColumn(columnIndex) {
  const table = document.getElementById('licitacionesTable');
  const rows = table.getElementsByTagName('tr');
  const hiddenColumnsList = document.getElementById('hiddenColumnsList');

  let isHidden = false;

  for (let i = 0; i < rows.length; i++) {
    const headers = rows[i].getElementsByTagName('th');
    const cells = rows[i].getElementsByTagName('td');

    if (i === 0 && headers.length > columnIndex) {
      // Alternar visibilidad del encabezado
      const header = headers[columnIndex];
      if (header.style.display === 'none') {
        header.style.display = 'table-cell';
        // Eliminar de la lista de columnas ocultas
        const listItem = document.querySelector(`#hiddenColumnsList li[data-index="${columnIndex}"]`);
        if (listItem) listItem.remove();
      } else {
        header.style.display = 'none';
        isHidden = true;
        // A√±adir a la lista de columnas ocultas
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item';
        listItem.textContent = header.textContent;
        listItem.setAttribute('data-index', columnIndex);
        listItem.onclick = () => toggleColumn(columnIndex); // Restaurar al hacer clic
        hiddenColumnsList.appendChild(listItem);
      }
    } else if (cells.length > columnIndex) {
      // Alternar visibilidad de las celdas
      if (isHidden) {
        cells[columnIndex].style.display = 'none';
      } else {
        cells[columnIndex].style.display = 'table-cell';
      }
    }
  }

  // Actualizar la lista de columnas ocultas
  updateHiddenColumnsList();
}

function updateHiddenColumnsList() {
  const table = document.getElementById('licitacionesTable');
  const rows = table.getElementsByTagName('tr');
  const hiddenColumnsList = document.getElementById('hiddenColumnsList');

  // Limpiar la lista actual
  hiddenColumnsList.innerHTML = '';

  // Recorrer las columnas del encabezado
  const headers = rows[0].getElementsByTagName('th');
  for (let i = 0; i < headers.length; i++) {
    if (headers[i].style.display === 'none') {
      // Si la columna est√° oculta, agregarla a la lista
      const listItem = document.createElement('li');
      listItem.className = 'list-group-item';
      listItem.textContent = headers[i].textContent;
      listItem.setAttribute('data-index', i);
      listItem.onclick = () => toggleColumn(i); // Restaurar al hacer clic
      hiddenColumnsList.appendChild(listItem);
    }
  }

  updateHiddenColumnsVisibility();
}

function updateHiddenColumnsVisibility() {
  const hiddenColumnsContainer = document.getElementById('hiddenColumnsContainer');
  const hiddenColumnsList = document.getElementById('hiddenColumnsList');
  hiddenColumnsContainer.style.display = hiddenColumnsList.children.length > 0 ? 'block' : 'none';
}

document.getElementById('updateButton').addEventListener('click', async () => {
  if (confirm('¬øEst√°s seguro de que deseas actualizar las licitaciones?')) {
    try {
      const response = await fetch('http://127.0.0.1:5000/update-licitaciones', { // Cambia el puerto si es necesario
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      const result = await response.json();
      if (result.success) {
        alert(result.message);
        location.reload(); // Recarga la p√°gina para mostrar los datos actualizados
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error al actualizar las licitaciones.');
    }
  }
});


document.getElementById('downloadButton').addEventListener('click', async () => {
  const table = document.getElementById('licitacionesTable');
  const rows = table.getElementsByTagName('tr');
  const data = [];
  const codList = []; // Lista para almacenar los c√≥digos visibles

  // Recorrer las filas visibles de la tabla
  for (let i = 0; i < rows.length; i++) {
    if (rows[i].style.display !== 'none') { // Solo incluir filas visibles
      const cells = rows[i].getElementsByTagName(i === 0 ? 'th' : 'td'); // Usar 'th' para encabezados
      const rowData = [];
      for (let j = 0; j < cells.length; j++) {
        rowData.push(cells[j].textContent.trim());
      }
      data.push(rowData);

      // Agregar el c√≥digo (COD) a codList si no es la fila de encabezado
      if (i > 0) {
        codList.push(cells[0].textContent.trim()); // Suponiendo que el COD est√° en la primera columna
      }
    }
  }

  // Crear la primera hoja con los datos de la tabla actual
  const ws1 = XLSX.utils.aoa_to_sheet(data); // Convierte los datos a una hoja de c√°lculo
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws1, 'Licitaciones');

  // Obtener los datos de la tabla SQL "anexoI" desde el servidor
  try {
    const response = await fetch('http://127.0.0.1:5000/get-anexoI-data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ cod_list: codList }) // Enviar codList al servidor
    });

    const anexoIData = await response.json();

    // Convertir los datos de "anexoI" a un formato adecuado para Excel
    const anexoIArray = [];
    if (anexoIData.length > 0) {
      // Agregar encabezados
      anexoIArray.push(Object.keys(anexoIData[0]));
      // Agregar filas
      anexoIData.forEach(row => {
        anexoIArray.push(Object.values(row));
      });
    }

    // Crear la segunda hoja con los datos de "anexoI"
    const ws2 = XLSX.utils.aoa_to_sheet(anexoIArray);
    XLSX.utils.book_append_sheet(wb, ws2, 'anexoI');
  } catch (error) {
    console.error('Error al obtener los datos de anexoI:', error);
    alert('No se pudo agregar la hoja "anexoI" al archivo Excel.');
  }

  // Descargar el archivo
  XLSX.writeFile(wb, 'licitaciones_con_anexoI.xlsx');
});

document.addEventListener('DOMContentLoaded', () => {
  const rows = document.querySelectorAll('#licitacionesTable tbody tr');
  const totalLicitaciones = rows.length;
  document.getElementById('totalLicitaciones').textContent = totalLicitaciones;
  document.getElementById('numLicitaciones').textContent = totalLicitaciones;
  updateTotalLicitaciones();
});


// Bot√≥n para abrir el modal de selecci√≥n de columnas
document.getElementById('columnSelectorButton').addEventListener('click', () => {
  const table = document.getElementById('licitacionesTable');
  const headers = table.querySelectorAll('thead th');
  const form = document.getElementById('columnSelectorForm');
  form.innerHTML = '';
  headers.forEach((th, i) => {
    // No permitir ocultar la columna de acciones (√∫ltima)
    if (i === headers.length - 1) return;
    const checked = th.style.display !== 'none' ? 'checked' : '';
    form.innerHTML += `
      <div>
        <input type="checkbox" id="colCheck${i}" data-index="${i}" ${checked}>
        <label for="colCheck${i}">${th.textContent}</label>
      </div>
    `;
  });
  const modal = new bootstrap.Modal(document.getElementById('columnSelectorModal'));
  modal.show();
});

// Aplicar selecci√≥n de columnas
document.getElementById('applyColumnSelection').addEventListener('click', () => {
  const table = document.getElementById('licitacionesTable');
  const headers = table.querySelectorAll('thead th');
  const rows = table.querySelectorAll('tbody tr');
  const checks = document.querySelectorAll('#columnSelectorForm input[type="checkbox"]');
  checks.forEach(check => {
    const idx = parseInt(check.dataset.index);
    headers[idx].style.display = check.checked ? '' : 'none';
    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells[idx]) cells[idx].style.display = check.checked ? '' : 'none';
    });
  });
  // Cerrar el modal
  bootstrap.Modal.getInstance(document.getElementById('columnSelectorModal')).hide();
  updateHiddenColumnsList();
});

// Seleccionar todas las columnas
document.getElementById('selectAllColumns').addEventListener('click', () => {
  document.querySelectorAll('#columnSelectorForm input[type="checkbox"]').forEach(cb => cb.checked = true);
});

// Deseleccionar todas las columnas
document.getElementById('deselectAllColumns').addEventListener('click', () => {
  document.querySelectorAll('#columnSelectorForm input[type="checkbox"]').forEach(cb => cb.checked = false);
});


function applyFilter(columnIndex) {
  const input = document.querySelector(`.filter-input[data-column="${columnIndex}"]`);
  const filterValue = input.value.trim();

  // Actualizar el filtro en el array
  columnFilters[columnIndex] = filterValue;

  // Aplicar los filtros acumulativos
  applyAllFilters();
}

function applyAllFilters() {
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    let isVisible = true;

    columnFilters.forEach((value, index) => {
      const cell = row.cells[index];
      if (cell) {
        const cellText = cell.textContent.trim();

        if (typeof value === 'string' && value) {
          // Filtro por texto (expresi√≥n regular)
          try {
            const regex = new RegExp(value, 'i'); // 'i' para ignorar may√∫sculas/min√∫sculas
            if (!regex.test(cellText)) {
              isVisible = false;
            }
          } catch (error) {
            console.error(`Error en la expresi√≥n regular: ${value}`, error);
            isVisible = false;
          }
        } else if (value && value.startDate && value.endDate) {
          // Filtro por rango de fechas
          const cellDate = new Date(cellText);
          if (isNaN(cellDate.getTime()) || cellDate < value.startDate || cellDate > value.endDate) {
            isVisible = false;
          }
        }
      }
    });

    row.style.display = isVisible ? '' : 'none'; // Mostrar u ocultar la fila
  });

  updateTotalLicitaciones(); // Actualizar el contador de licitaciones visibles
}

document.addEventListener('DOMContentLoaded', () => {
  const filterIcons = document.querySelectorAll('.filter-icon');
  filterIcons.forEach((icon, index) => {
    icon.addEventListener('click', event => toggleFilterMenu(event, index));
  });
});


document.addEventListener('DOMContentLoaded', function () {
  const tableContainer = document.getElementById('tableScrollContainer');
  const fixedScrollbar = document.getElementById('fixedTableScrollbar');
  const fixedScrollbarInner = document.getElementById('fixedScrollbarInner');
  const table = document.getElementById('licitacionesTable');

  function updateScrollbarWidth() {
    setTimeout(() => {
      fixedScrollbarInner.style.width = table.scrollWidth + 'px';
    }, 0);
  }

  fixedScrollbar.addEventListener('scroll', function () {
    tableContainer.scrollLeft = fixedScrollbar.scrollLeft;
  });

  tableContainer.addEventListener('scroll', function () {
    fixedScrollbar.scrollLeft = tableContainer.scrollLeft;
  });

  function toggleScrollbar() {
    if (table.scrollWidth > tableContainer.clientWidth) {
      fixedScrollbar.style.display = 'block';
      updateScrollbarWidth();
    } else {
      fixedScrollbar.style.display = 'none';
    }
  }

  toggleScrollbar();
  window.addEventListener('resize', toggleScrollbar);
});

function toggleFilterMenu(event, columnIndex) {
  const menus = document.querySelectorAll('.filter-menu');
  menus.forEach(menu => (menu.style.display = 'none'));

  const menu = document.querySelector(`.filter-menu[data-column="${columnIndex}"]`);
  const icon = event.target;
  const rect = icon.getBoundingClientRect();

  menu.style.display = 'block';
  menu.style.top = `${rect.bottom + window.scrollY}px`;
  menu.style.left = `${rect.left + window.scrollX}px`;
}

function clearFilter(columnIndex) {
  const input = document.querySelector(`.filter-input[data-column="${columnIndex}"]`);
  input.value = '';

  // Eliminar el filtro de la columna en el array
  columnFilters[columnIndex] = '';

  // Aplicar los filtros acumulativos
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    let isVisible = true;

    columnFilters.forEach((value, index) => {
      if (value) {
        const cell = row.cells[index];
        if (cell) {
          const cellText = cell.textContent.trim();

          try {
            // Crear una expresi√≥n regular basada en el valor del filtro
            const regex = new RegExp(value, 'i'); // 'i' para ignorar may√∫sculas/min√∫sculas
            isVisible = regex.test(cellText);
          } catch (error) {
            console.error(`Error en la expresi√≥n regular: ${value}`, error);
            isVisible = false;
          }
        } else {
          isVisible = false;
        }
      }
    });

    row.style.display = isVisible ? '' : 'none'; // Mostrar u ocultar la fila
  });

  updateTotalLicitaciones(); // Actualizar el contador de licitaciones visibles
}

function updateVisibility() {
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    const isVisible = Array.from(row.cells).every(cell => {
      return row.dataset.visible !== 'false';
    });

    row.style.display = isVisible ? '' : 'none'; // Muestra u oculta la fila
  });

  updateTotalLicitaciones(); // Actualizar el contador de licitaciones visibles
}

function updateTotalLicitaciones() {
  const rows = document.querySelectorAll('#licitacionesTable tbody tr');
  let visibleCount = 0;
  let totalEuros = 0;

  rows.forEach(row => {
    if (row.style.display !== 'none') {
      visibleCount++;

      // Obtener el valor de la columna "Presupuesto Base" (√≠ndice 8)
      const presupuestoCell = row.cells[8];
      if (presupuestoCell) {
        const presupuestoText = presupuestoCell.textContent.trim();
        const presupuestoValue = parseFloat(
          presupuestoText.replace(/\./g, '').replace(',', '.')
        ); // Eliminar separadores de miles y convertir a n√∫mero
        if (!isNaN(presupuestoValue)) {
          totalEuros += presupuestoValue;
        }
      }
    }
  });

  // Actualizar el contador de licitaciones visibles
  const totalLicitacionesElement = document.getElementById('totalLicitaciones');
  const numLicitacionesElement = document.getElementById('numLicitaciones');

  if (totalLicitacionesElement) {
    totalLicitacionesElement.textContent = totalEuros.toLocaleString('es-ES', {
      style: 'currency',
      currency: 'EUR',
    });
  }

  if (numLicitacionesElement) {
    numLicitacionesElement.textContent = visibleCount;
  }
}

function applyDateFilter(columnIndex) {
  let startDateInput = null;
  let endDateInput = null;

  // Asignar valores solo si columnIndex es 21
  if (columnIndex === 21) {
    startDateInput = document.getElementById('fechaInicioAdjudicacion').value;
    endDateInput = document.getElementById('fechaFinAdjudicacion').value;
  }
  else if (columnIndex === 22) {
    startDateInput = document.getElementById('fechaInicioFormalizacion').value;
    endDateInput = document.getElementById('fechaFinFormalizacion').value;
  } else if (columnIndex === 23) {
    startDateInput = document.getElementById('fechaInicioDesistimiento').value;
    endDateInput = document.getElementById('fechaFinDesistimiento').value;
  } else if (columnIndex === 24) {
    startDateInput = document.getElementById('fechaInicioPresentacionOferta').value;
    endDateInput = document.getElementById('fechaFinPresentacionOferta').value;
  } else if (columnIndex === 25) {
    startDateInput = document.getElementById('fechaInicioPresentacionSolicitud').value;
    endDateInput = document.getElementById('fechaFinPresentacionSolicitud').value;
  }
  
  const startDate = startDateInput ? new Date(startDateInput) : null;
  const endDate = endDateInput ? new Date(endDateInput) : null;

  // Actualizar el filtro de fechas en el array
  columnFilters[columnIndex] = { startDate, endDate };

  // Aplicar los filtros acumulativos
  applyAllFilters();
}

function clearDateFilter(columnIndex) {
  document.getElementById('fechaInicioAdjudicacion').value = '';
  document.getElementById('fechaFinAdjudicacion').value = '';

  // Eliminar el filtro de fechas en el array
  columnFilters[columnIndex] = '';

  // Aplicar los filtros acumulativos
  applyAllFilters();
}

function clearAllFilters() {
  // Limpiar todos los filtros en el array
  columnFilters.length = 0;

  // Limpiar los campos de entrada de texto
  const textFilters = document.querySelectorAll('.filter-input');
  textFilters.forEach(filter => {
    filter.value = '';
  });

  // Limpiar los campos de rango de fechas
  const dateInputs = document.querySelectorAll('input[type="date"]');
  dateInputs.forEach(input => {
    input.value = '';
  });

  // Mostrar todas las filas de la tabla
  const table = document.getElementById('licitacionesTable');
  const rows = table.querySelectorAll('tbody tr');
  rows.forEach(row => {
    row.style.display = ''; // Mostrar todas las filas
  });

  // Actualizar el contador de licitaciones visibles
  updateTotalLicitaciones();

  // Recargar la p√°gina
  location.reload();
}
</script>

{% endblock %}