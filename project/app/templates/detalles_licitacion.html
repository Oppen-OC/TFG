{% extends 'base.html' %}

{% block title %}Detalles de la Licitación{% endblock %}

{% block content %}
<h2 class="mb-4">Detalles de la Licitación</h2>

<table class="table table-bordered">
  <tr>
    <th>Código</th>
    <td>{{ licitacion.COD }}</td>
  </tr>
  <tr>
    <th>ID Publicación TED</th>
    <td>{{ licitacion.ID_publicacion_TED }}</td>
  </tr>
  <tr>
    <th>Órgano de Contratación</th>
    <td>{{ licitacion.Organo_Contratacion }}</td>
  </tr>
  <tr>
    <th>ID Órgano de Contratación</th>
    <td>{{ licitacion.ID_Organo_contratacion }}</td>
  </tr>
  <tr>
    <th>Estado de la Licitación</th>
    <td>{{ licitacion.Estado_Licitacion }}</td>
  </tr>
  <tr>
    <th>Objeto del Contrato</th>
    <td>{{ licitacion.Objeto_contrato }}</td>
  </tr>
  <tr>
    <th>Financiación UE</th>
    <td>{{ licitacion.Financiacion_UE }}</td>
  </tr>
  <tr>
    <th>Presupuesto Base</th>
    <td>{{ licitacion.Presupuesto_base }}</td>
  </tr>
  <tr>
    <th>Valor Estimado del Contrato</th>
    <td>{{ licitacion.Valor_Estimado_Contrato }}</td>
  </tr>
  <tr>
    <th>Tipo de Contrato</th>
    <td>{{ licitacion.Tipo_contrato }}</td>
  </tr>
  <tr>
    <th>Código CPV</th>
    <td>{{ licitacion.Codigo_CPV }}</td>
  </tr>
  <tr>
    <th>Lugar de Ejecución</th>
    <td>{{ licitacion.Lugar_ejecucion }}</td>
  </tr>
  <tr>
    <th>Sistema de Contratación</th>
    <td>{{ licitacion.Sistema_contratacion }}</td>
  </tr>
  <tr>
    <th>Procedimiento de Contratación</th>
    <td>{{ licitacion.Procedimiento_contratacion }}</td>
  </tr>
  <tr>
    <th>Tipo de Contratación</th>
    <td>{{ licitacion.Tipo_contratacion }}</td>
  </tr>
  <tr>
    <th>Método de Presentación de Oferta</th>
    <td>{{ licitacion.Metodo_presentacion_oferta }}</td>
  </tr>
  <tr>
    <th>Resultado</th>
    <td>{{ licitacion.Resultado }}</td>
  </tr>
  <tr>
    <th>Adjudicatario</th>
    <td>{{ licitacion.Adjudicatario }}</td>
  </tr>
  <tr>
    <th>Número de Licitaciones Presentadas</th>
    <td>{{ licitacion.Numero_licitaciones_presentadas }}</td>
  </tr>
  <tr>
    <th>Importe de Adjudicación</th>
    <td>{{ licitacion.Importe_adjudicacion }}</td>
  </tr>
  <tr>
    <th>Fecha de Adjudicación</th>
    <td>{{ licitacion.Fecha_Adjudicacion }}</td>
  </tr>
  <tr>
    <th>Fecha de Formalización</th>
    <td>{{ licitacion.Fecha_Formalizacion }}</td>
  </tr>
  <tr>
    <th>Fecha de Desistimiento</th>
    <td>{{ licitacion.Fecha_Desistimiento }}</td>
  </tr>
  <tr>
    <th>Fecha de Presentación de Oferta</th>
    <td>{{ licitacion.Fecha_Presentacion_Oferta }}</td>
  </tr>
  <tr>
    <th>Fecha de Presentación de Solicitud</th>
    <td>{{ licitacion.Fecha_Presentacion_Solicitud }}</td>
  </tr>
</table>

<!-- Enlaces a los documentos -->
<h3 class="mt-5">Documentos Relacionados</h3>
<ul>
  {% if pliego_administrativo_url %}
  <li><a href="{{ pliego_administrativo_url}}" target="_blank">📄 Pliego Administrativo</a></li>
  {% else %}
  <li>📄 Pliego Administrativo: No disponible</li>
  {% endif %}

  {% if anexo_url %}
  <li>
    <a href="{{ anexo_url }}" target="_blank">
      📄 {{ titulo_anexo }}
    </a>
  </li>
  {% else %}
  <li>📄 Anexo: No disponible</li>
  {% endif %}
</ul>

<!-- Botón para cargar el anexo -->
<button id="cargarAnexoButton" class="btn btn-primary mt-3">Cargar Anexo</button>

<!-- Contenedor del anexo, inicialmente vacío -->
<div id="anexoContainer" style="display: none;">
  <h3 class="mt-5">Detalles del Anexo</h3>
  <div id="anexoContent"></div>
</div>

<!-- Modal Bootstrap para mostrar la ubicación -->
<div class="modal fade" id="ubicacionModal" tabindex="-1" aria-labelledby="ubicacionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ubicacionModalLabel">Ubicación en el documento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="ubicacionModalBody">
        <!-- Aquí se mostrará la información de fuente -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bloque de datos JSON seguro -->
<script type="application/json" id="anexoI-fuentes-data">
  {{ anexoI_fuentes|default:"{}"|safe }}
</script>

<script>
  let anexoI_fuentes = {};
  try {
    anexoI_fuentes = JSON.parse(document.getElementById('anexoI-fuentes-data').textContent);
  } catch (e) {
    anexoI_fuentes = {};
    console.warn("anexoI-fuentes-data JSON inválido o vacío");
  }
  console.log(anexoI_fuentes); // <-- Añade esto para depurar

  function mostrarUbicacion(campo) {
    console.log("Mostrando ubicación para el campo:", campo);
    const fuente = anexoI_fuentes[campo];
    console.log("Fuente encontrada:", fuente);
    let mensaje = "Información no disponible.";

    if (fuente) {
        // Add \n before "Page: n" and after the number
        mensaje = fuente.replace(/Page: (\d+)/g, (match, pageNumber) => {
            return `\n<strong style="color: #007bff;">Page: ${pageNumber}</strong>\n`;
        });

        // Highlight "Chunk: n" and keep the rest of the content
        mensaje = mensaje.replace(/Chunk: (\d+)/g, (match, chunkNumber) => {
            return `<strong style="color: #28a745;">Chunk: ${chunkNumber}</strong>`;
        });
    }

    document.getElementById('ubicacionModalBody').innerHTML = `<div style="white-space: pre-line; line-height: 1.6; font-size: 1rem;">${mensaje}</div>`;
    var myModal = new bootstrap.Modal(document.getElementById('ubicacionModal'));
    myModal.show();
  }

  // Mostrar u ocultar el contenedor del anexo al hacer clic en el botón
  document.getElementById('cargarAnexoButton').addEventListener('click', function() {
    const container = document.getElementById('anexoContainer');
    if (container.style.display === 'none' || container.style.display === '') {
      container.style.display = 'block';
      this.textContent = 'Ocultar Anexo';
    } else {
      container.style.display = 'none';
      this.textContent = 'Cargar Anexo';
    }
  });

  document.getElementById('cargarAnexoButton').addEventListener('click', function () {
    const button = this; // Referencia al botón
    button.disabled = true; // Deshabilitar el botón
    button.textContent = 'Cargando...'; // Cambiar el texto del botón

    const cod = "{{ licitacion.COD }}"; // Obtén el código de la licitación desde el contexto
    const anexoContainer = document.getElementById('anexoContainer');
    const anexoContent = document.getElementById('anexoContent');

    // Realizar la solicitud AJAX
    fetch('http://127.0.0.1:5000/cargar-anexo', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ cod: cod }),
    })
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al cargar el anexo");
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }

        // Construir el contenido del anexo
        const anexoI = data.anexoI;
        const orderedFields = [
          "COD", "Regulacion_armonizada", "Sometido_recurso_especial", "Plazo_ejecución",
          "Presupuesto_sinIVA", "Presupuesto_conIVA", "Importe_IVA", "Sistema_Retribucion",
          "Valor_estimado", "Revision_precios", "Garantia_definitiva", "Garantia_provisional",
          "Admisibilidad_variantes", "Clasificacion", "Grupo", "Subgrupo", "Categoria",
          "Criterio_Solvencia_economica", "Criterio_Solvencia_tecnica", "Condiciones_especiales",
          "Penalidad_incumplimiento", "Forma_pago", "Causas_modificacion", "Plazo_garantia",
          "Contratacion_precio_unit", "Tanto_alzado", "Tanto_alzado_con", "Criterio_juicio_val",
          "Evaluables_autom", "Criterio_ecónomico", "Obligaciones_ambientales", "Regimen_penalidades",
          "Ambiental", "Tecnico", "Precio", "Garantia", "Experiencia", "Calidad", "Social",
          "Seguridad", "Juicio_valor", "Formula_precio", "Formula_JuicioValor",
          "Criterios_valores_anormales", "Infraccion_grave", "Gastos_desistimiento",
          "Contratacion_control", "Tareas_criticas"
        ];

        let html = '<table class="table table-bordered">';
        orderedFields.forEach(key => {
          html += `
            <tr>
              <th>${key.replace(/_/g, ' ')}</th>
              <td>${anexoI[key] || 'N/A'}</td>
            </tr>
          `;
        });
        html += '</table>';

        // Mostrar el contenido en el contenedor
        anexoContent.innerHTML = html;
        anexoContainer.style.display = 'block';

        // Ocultar el botón
        button.style.display = 'none';
      })
      .catch(error => {
        console.error(error);
        alert("Hubo un error al cargar el anexo.");
      })
      .finally(() => {
        button.disabled = false; // Habilitar el botón nuevamente
        button.textContent = 'Cargar Anexo'; // Restaurar el texto original del botón
      });
  });
</script>

{% if licitacion %}
<a href="{% url 'app:licitaciones' %}" class="btn btn-secondary mt-3">Volver a licitaciones</a>
{% else %}
<p class="text-danger">No se encontraron detalles para esta licitación.</p>
{% endif %}

{% endblock %}